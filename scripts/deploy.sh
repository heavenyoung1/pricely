#!/bin/bash
set -e  # ะพััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะฒัะฟะพะปะฝะตะฝะธะต ะฟัะธ ะฟะตัะฒะพะน ะถะต ะพัะธะฑะบะต

echo "๐ ะะฐัะธะฝะฐะตะผ ะดะตะฟะปะพะน..."

# 1. ะะฑะฝะพะฒะปัะตะผ ะบะพะด
echo "๐ฅ ะะฑะฝะพะฒะปัะตะผ ัะตะฟะพะทะธัะพัะธะน..."
git fetch --all
git reset --hard origin/main   # ะตัะปะธ ั ัะตะฑั ะฒะตัะบะฐ ะฝะฐะทัะฒะฐะตััั master โ ะฟะพะผะตะฝัะน ะฝะฐ master

# 2. ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะธ ัะดะฐะปัะตะผ ะบะพะฝัะตะนะฝะตัั
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ะธ ัะดะฐะปัะตะผ ััะฐััะต ะบะพะฝัะตะนะฝะตัั..."
make down

# 3. ะงะธััะธะผ ะผััะพั Docker (ะพะฟัะธะพะฝะฐะปัะฝะพ)
echo "๐งน ะงะธััะธะผ ะฝะตะธัะฟะพะปัะทัะตะผัะต ะพะฑัะฐะทั ะธ ะบะพะฝัะตะนะฝะตัั..."
docker system prune -af --volumes

# 4. ะะพะดะฝะธะผะฐะตะผ ะฝะพะฒัะต ะบะพะฝัะตะนะฝะตัั
echo "๐ณ ะะพะดะฝะธะผะฐะตะผ ะบะพะฝัะตะนะฝะตัั..."
make up

# 5. ะะดัะผ ะฟะพะบะฐ Postgres ััะฐะฝะตั ะดะพัััะฟะฝัะผ
echo "โณ ะะดัะผ ะณะพัะพะฒะฝะพััะธ Postgres..."
until docker exec pricely_postgres_dev pg_isready -U postgres > /dev/null 2>&1; do
  sleep 2
done
until docker exec pricely_postgres_test pg_isready -U postgres > /dev/null 2>&1; do
  sleep 2
done
echo "โ Postgres ะณะพัะพะฒ!"

# 6. ะัะธะผะตะฝัะตะผ ะผะธะณัะฐัะธะธ (ะธ ะดะปั dev, ะธ ะดะปั test)
echo "๐ ะัะธะผะตะฝัะตะผ ะผะธะณัะฐัะธะธ..."
make migrate-all

# 7. (ะพะฟัะธะพะฝะฐะปัะฝะพ) ะัะพะณะพะฝัะตะผ ัะตััั
echo "๐งช ะะฐะฟััะบะฐะตะผ ัะตััั..."
make test || { echo "โ ะขะตััั ัะฟะฐะปะธ!"; exit 1; }

echo "๐ ะะตะฟะปะพะน ะทะฐะฒะตัััะฝ ััะฟะตัะฝะพ!"
