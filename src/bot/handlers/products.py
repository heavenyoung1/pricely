from telebot.types import Message
from requests import head
import logging
import sys
import uuid
from datetime import datetime

from src.bot.keyboards.main_menu import main_menu
from src.infrastructure.core.ozon_parser import OzonParser
from src.infrastructure.services import ProductService
from src.domain.entities import Product, Price, User
from src.infrastructure.database.core import get_db_session


logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('ozon_parser.log', encoding='utf-8'),
        logging.StreamHandler(sys.stdout)
    ]
)
logger = logging.getLogger(__name__)

# —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_states = {}

# —Å–µ—Ä–≤–∏—Å—ã
parser = OzonParser()
product_service = ProductService(uow_factory=get_db_session)

def register_handlers(bot):

    @bot.message_handler(func=lambda m: m.text == "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä")
    def add_product(message: Message):
        user_states[message.chat.id] = "waiting_for_product_url"
        bot.send_message(message.chat.id, "–û—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –Ω–∞ —Ç–æ–≤–∞—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä —Å Ozon).")

    @bot.message_handler(func=lambda m: m.text == "‚ûñ –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä")
    def remove_product(message: Message):
        bot.send_message(message.chat.id, "–í—ã–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞).")

    @bot.message_handler(func=lambda m: m.text == "üìã –ú–æ–∏ —Ç–æ–≤–∞—Ä—ã")
    def list_products(message: Message):
        bot.send_message(message.chat.id, "–¢–≤–æ–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã–µ —Ç–æ–≤–∞—Ä—ã (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞).")

    # –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä
    @bot.message_handler(func=lambda m: user_states.get(m.chat.id) == 'waiting_for_product_url')
    def handle_product_url(message: Message):
        url = message.text.strip()
        user_id = str(message.from_user.id)

        # –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–∏—Å
        result = product_service.create_product(user_id, url)

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        if result["success"]:
            bot.send_message(message.chat.id, result["message"], reply_markup=main_menu())
        else:
            bot.send_message(message.chat.id, result["message"], reply_markup=main_menu())
        logger.info(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ URL {url} –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {result['message']}")

        # –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è
        del user_states[message.chat.id]