import logging
from aiogram.exceptions import TelegramAPIError, TelegramBadRequest

logger = logging.getLogger(__name__)

class NotificationService:
    def __init__(self, bot):
        self.bot = bot

    async def notify_price_change(self, chat_id: str, updated_product: dict):
        """
        –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å —Ü–µ–Ω–∞.
        """
        try:
            logger.info(f"üì® NotificationService: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {chat_id}")

            text = f"üîî –¶–µ–Ω–∞ –Ω–∞ —Ç–æ–≤–∞—Ä –∏–∑–º–µ–Ω–∏–ª–∞—Å—å!\n\n" \
                   f"üì¶ {updated_product['name']}\n\n" \
                   f"üí∞ –°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞: {updated_product['latest_price']['previous_price_with_card']} ‚ÇΩ\n" \
                   f"üí∞ –ù–æ–≤–∞—è —Ü–µ–Ω–∞: {updated_product['latest_price']['with_card']} ‚ÇΩ\n\n" \
                   f"üîó {updated_product['link']}"

            await self.bot.send_message(
                chat_id=int(chat_id),
                text=text
            )

            logger.info(f"‚úÖ NotificationService: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {chat_id}")

        except (TelegramBadRequest, TelegramAPIError) as e:
            logger.error(f"‚ùå NotificationService: –û—à–∏–±–∫–∞ Telegram API: {e}")
        except Exception as e:
            logger.exception(f"‚ùå NotificationService: –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞: {e}")