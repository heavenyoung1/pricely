import logging
from aiogram.exceptions import TelegramAPIError, TelegramBadRequest, TelegramForbiddenError
import asyncio

logger = logging.getLogger(__name__)

class NotificationService:
    """
    –°–µ—Ä–≤–∏—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞.
    """
    
    def __init__(self, bot):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.
        
        Args:
            bot: –≠–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ aiogram
        """
        self.bot = bot

    async def notify_price_change(self, chat_id: str, updated_product: dict):
        """
        –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ü–µ–Ω—ã —Ç–æ–≤–∞—Ä–∞.
        
        Args:
            chat_id: ID —á–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            updated_product: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–º —Ç–æ–≤–∞—Ä–µ
        """
        try:
            logger.info(f"üì® NotificationService: –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {chat_id}")

            new_price_with_card = updated_product['latest_price']['with_card']
            new_price_without_card = updated_product['latest_price']['without_card']

            prev_price_with_card = updated_product['latest_price']['previous_price_with_card']
            prev_price_without_card = updated_product['latest_price']['previous_price_without_card']

            price_diff = new_price_with_card - prev_price_with_card
            price_emoji = "üìâ" if price_diff < 0 else "üìà"

            text = (
                f"{price_emoji} –¶–µ–Ω–∞ –Ω–∞ —Ç–æ–≤–∞—Ä –∏–∑–º–µ–Ω–∏–ª–∞—Å—å!\n\n"
                f"üì¶ {updated_product['name']}\n\n"
                f"üí∞ –ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (—Å –∫–∞—Ä—Ç–æ–π): {new_price_with_card} ‚ÇΩ\n"
                f"üí∞ –ê–∫—Ç—É–∞–ª—å–Ω–∞—è —Ü–µ–Ω–∞ (–±–µ–∑ –∫–∞—Ä—Ç—ã): {new_price_without_card} ‚ÇΩ\n"             
                f"üí∞ –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ü–µ–Ω–∞ (—Å –∫–∞—Ä—Ç–æ–π): {prev_price_with_card} ‚ÇΩ\n"
                 f"üí∞ –ü—Ä–µ–¥—ã–¥—É—â–∞—è —Ü–µ–Ω–∞ (—Å –∫–∞—Ä—Ç–æ–π): {prev_price_without_card} ‚ÇΩ\n"

                f"{'üíö' if price_diff < 0 else 'üî¥'} –†–∞–∑–Ω–∏—Ü–∞: {price_diff:+d} ‚ÇΩ\n\n"
                f"üîó {updated_product['link']}"
            )

            await self.bot.send_message(
                chat_id=int(chat_id),
                text=text,
                disable_web_page_preview=False
            )

            logger.info(f"‚úÖ NotificationService: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {chat_id}")

        except TelegramForbiddenError:
            logger.warning(f"‚ö†Ô∏è –ë–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {chat_id}")

        except TelegramBadRequest as e:
            logger.error(f"‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è —á–∞—Ç–∞ {chat_id}: {e}")

        except TelegramAPIError as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ Telegram API –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è {chat_id}: {e}")
            
        except Exception as e:
            logger.exception(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è {chat_id}: {e}")

    async def notify_multiple_users(self, users_chat_ids: list, updated_product: dict):
        """
        –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.
        
        Args:
            users_chat_ids: –°–ø–∏—Å–æ–∫ ID —á–∞—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            updated_product: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±–Ω–æ–≤–ª—ë–Ω–Ω–æ–º —Ç–æ–≤–∞—Ä–µ
        """
        for chat_id in users_chat_ids:
            await self.notify_price_change(chat_id, updated_product)
            # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –æ—Ç–ø—Ä–∞–≤–∫–∞–º–∏, —á—Ç–æ–±—ã –Ω–µ –ø–æ–ø–∞—Å—Ç—å –ø–æ–¥ rate limit
            await asyncio.sleep(0.3)