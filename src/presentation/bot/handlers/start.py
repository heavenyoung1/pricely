from telebot.types import Message
from src.presentation.bot.bot_instance import bot
from src.presentation.bot.keyboards.main_menu import main_menu
from src.presentation.bot.service_connector import service
from src.domain.entities import User

import logging

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

@bot.message_handler(commands=["start"])
def start_handler(message: Message):
    user = User(
        id=str(message.from_user.id),
        username=message.from_user.username or "unknown",
        chat_id=str(message.chat.id),
    )
    try:
        service.create_user(user)
        logger.info(f"User {user.id} —Å–æ–∑–¥–∞–Ω –∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")
    except Exception as e:
        logger.warning(f"–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.id}: {e}")
                # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º, —Ç–∞–∫ –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É–∂–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å

    bot.send_message(
        message.chat.id,
        "üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –Ø –±–æ—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ü–µ–Ω Ozon.",
        reply_markup=main_menu()
    )

@bot.message_handler(commands=["help"])
def help_handler(message: Message):
    logger.debug(f"Received /help command from user {message.from_user.id}")
    text = (
        "üìñ –°–ø—Ä–∞–≤–∫–∞:\n\n"
        "‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä\n"
        "üìã –ú–æ–∏ —Ç–æ–≤–∞—Ä—ã\n"
        "‚ûñ –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä\n"
        "üóë –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ\n"
        "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
    )
    try:
        bot.send_message(message.chat.id, text, reply_markup=main_menu())
        logger.debug(f"Sent help message to chat {message.chat.id}")
    except Exception as e:
        logger.error(f"Failed to send help message to chat {message.chat.id}: {e}", exc_info=True)

@bot.message_handler(content_types=['text'])
def echo_handler(message: Message):
    logger.debug(f"Received text message from user {message.from_user.id}: {message.text}")
    try:
        bot.reply_to(message, f"You said: {message.text}")
        logger.debug(f"Replied to message in chat {message.chat.id}")
    except Exception as e:
        logger.error(f"Failed to reply to message in chat {message.chat.id}: {e}", exc_info=True)