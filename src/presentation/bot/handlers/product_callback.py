from telebot.types import CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from src.presentation.bot.bot_instance import bot, format_product_message, build_product_actions_keyboard
from src.presentation.bot.service_connector import service
import logging

logger = logging.getLogger(__name__)

# üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—É
@bot.callback_query_handler(func=lambda call: call.data and call.data.startswith("update_price:"))
def handle_update_price(call: CallbackQuery):
    bot.answer_callback_query(call.id)
    product_id = call.data.split(":", 1)[1]

    try:
        updated_product = service.update_product_price(product_id)  # —Ç–≤–æ–π UseCase –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
        text = format_product_message(updated_product)
        kb = build_product_actions_keyboard(product_id=updated_product["id"], product_link=updated_product["link"])

        bot.edit_message_text(
            chat_id=call.message.chat.id,
            message_id=call.message.message_id,
            text=f"‚úÖ –¶–µ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!\n\n{text}",
            parse_mode="HTML",
            reply_markup=kb,
            disable_web_page_preview=False
        )
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Ü–µ–Ω—ã")
        bot.answer_callback_query(call.id, f"‚ùå –û—à–∏–±–∫–∞: {e}")

# üóë –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä
@bot.callback_query_handler(func=lambda call: call.data and call.data.startswith("delete_product:"))
def handle_delete_product(call: CallbackQuery):
    bot.answer_callback_query(call.id)
    product_id = call.data.split(":", 1)[1]

    try:
        service.delete_product(product_id)

        # –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –∑–∞–Ω–æ–≤–æ
        products = service.get_all_products(str(call.from_user.id))
        if not products:
            bot.edit_message_text(
                chat_id=call.message.chat.id,
                message_id=call.message.message_id,
                text="üì≠ –£ –≤–∞—Å –±–æ–ª—å—à–µ –Ω–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤"
            )
            return

        kb = InlineKeyboardMarkup(row_width=1)
        for p in products:
            name = p.get("name") or p.get("product_name") or p.get("id")
            display = name if len(name) <= 60 else name[:57] + "..."
            kb.add(InlineKeyboardButton(text=display, callback_data=f"product:{p['id']}"))

        bot.edit_message_text(
            chat_id=call.message.chat.id,
            message_id=call.message.message_id,
            text="üìã –í–∞—à–∏ —Ç–æ–≤–∞—Ä—ã (–ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è):",
            reply_markup=kb
        )
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞")
        bot.answer_callback_query(call.id, f"‚ùå –û—à–∏–±–∫–∞: {e}")

# ‚¨ÖÔ∏è –ù–∞–∑–∞–¥
@bot.callback_query_handler(func=lambda call: call.data == "back_to_products")
def handle_back_to_products(call: CallbackQuery):
    bot.answer_callback_query(call.id)

    try:
        products = service.get_all_products(str(call.from_user.id))
        if not products:
            bot.edit_message_text(
                chat_id=call.message.chat.id,
                message_id=call.message.message_id,
                text="üì≠ –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤"
            )
            return

        kb = InlineKeyboardMarkup(row_width=1)
        for p in products:
            name = p.get("name") or p.get("product_name") or p.get("id")
            display = name if len(name) <= 60 else name[:57] + "..."
            kb.add(InlineKeyboardButton(text=display, callback_data=f"product:{p['id']}"))

        bot.edit_message_text(
            chat_id=call.message.chat.id,
            message_id=call.message.message_id,
            text="üìã –í–∞—à–∏ —Ç–æ–≤–∞—Ä—ã:",
            reply_markup=kb
        )
    except Exception as e:
        logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –∫ —Å–ø–∏—Å–∫—É —Ç–æ–≤–∞—Ä–æ–≤")
        bot.answer_callback_query(call.id, f"‚ùå –û—à–∏–±–∫–∞: {e}")
